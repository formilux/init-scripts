#!/bin/bash

. `dirname $0`/functions

option	hostname	standard_option
option	modprobe 	multiple_option
option	sysctl		multiple_option
option	file_max	standard_option
option	rtc		standard_option	"local"

function do_start {
    local svcname=$1
    local instname=$2
    local arg

    arg=0
    while [ $arg -lt ${#opt_modprobe[*]} ]; do
	modprobe ${opt_modprobe[$arg]} || return 1
	arg=$[$arg+1]
    done
   
    if [ -n "$opt_file_max" ]; then
	echo $opt_file_max > /proc/sys/fs/file-max
    fi
   
    if [ -n "$opt_hostname" ] ; then
	echo "Setting hostname '$opt_hostname'"
	echo ${opt_hostname%%.*} >/proc/sys/kernel/hostname
	echo ${opt_hostname#*.} >/proc/sys/kernel/domainname
    fi

    if [ "$opt_rtc" = "utc" ]; then
	echo -n "Setting system time from hardware clock (UTC)... "
	hwclock --hctosys --utc
	echo "Done."
    elif [ "$opt_rtc" = "local" ]; then
	echo -n "Setting system time from hardware clock (Local time)... "
	hwclock --hctosys --localtime
	echo "Done."
    fi
    for arg in ${opt_sysctl[*]}; do
	local sysctl value
	sysctl=${arg%%=*}
	sysctl=${sysctl//.//}
	value=${arg##*=}
	if [ -e "/proc/sys/$sysctl" ]; then
	    echo $value > /proc/sys/$sysctl
	else
	    echo "Non-existent sysctl entry : $arg"
	fi
    done
    return 0
}

function do_status {
    local instname=$2
    echo "System status :"
    echo -n "Hostname : "; hostname
    echo "Modules list :"; lsmod
    return 0
}


function do_stop {
    local svcname=$1
    local instname=$2

    arg=${#opt_modprobe[*]}
    while [ $arg -gt 0 ]; do
	arg=$[$arg-1]
	rmmod -r ${opt_modprobe[$arg]} >/dev/null 2>&1
    done

    if [ "$opt_rtc" = "utc" ]; then
	echo -n "Saving system time to hardware clock (UTC)... "
	hwclock --systohc --utc
	echo "Done."
    elif [ "$opt_rtc" = "local" ]; then
	echo -n "Saving system time to hardware clock (Local time)... "
	hwclock --systohc --localtime
	echo "Done."
    fi

    return 0
}

function do_check {
    local svcname=$1
    local instname=$2
    
    read uptime idletime < /proc/uptime
    echo "$HOSTNAME $svcname.$instname $(date +%s) RUNNING ${uptime%%.*} OK"
}

load_config

